#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

if (( $# < 2 )) ; then
    >&2 echo "usage: git-would-merge <branch> <file> ..."
    exit 1
fi

branch="$1"
shift

mergeBase="$(git merge-base HEAD "$branch")"
echo "$mergeBase"

for filename ; do
    dirname="$(dirname "$filename")"
    basename="$(basename "$filename")"
    case "${basename}" in
        .*.*)
            basebasename="${basename%.*}"
            ext=".${basename##*.}"
            ;;
        .*)
            basebasename="${basename}"
            ext=""
            ;;
        *.*)
            basebasename="${basename%.*}"
            ext=".${basename##*.}"
            ;;
        *)
            basebasename="${basename}"
            ext=""
            ;;
    esac
    base="${dirname}/${basebasename}--BASE${ext}"
    ours="${dirname}/${basebasename}--OURS${ext}"
    theirs="${dirname}/${basebasename}--THEIRS${ext}"

    echo "-   $filename"
    echo "    $base"
    echo "    $ours"
    echo "    $theirs"

    case "${filename}" in
        ./*)     gitfilename="${filename}"   ;;
        ../*)    gitfilename="${filename}"   ;;
        /*)      gitfilename="${filename}"   ;;
        *)       gitfilename="./${filename}" ;;
    esac

    git show "HEAD:${gitfilename}"         >"${ours}"
    git show "${branch}:${gitfilename}"    >"${theirs}"
    git show "${mergeBase}:${gitfilename}" >"${base}"
done
