#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset

MAIN () {
    export GIT_PAGER=cat
    local action=find
    local green=$'\e'"[0;32m"
    local reset=$'\e'"[0m"
    local -i verbose=0
    local -i inline=0
    local mindepth=''
    local maxdepth=''
    local nopager=''
    local -i noheader=0
    while (( $# )) && [[ "$1" == "-"* ]] ; do
        case "$1" in
            -l|--list)
                action=list
                ;;
            -v|-verbose)
                verbose+=1
                ;;
            -i|--inline)
                inline=1
                ;;
            --no-header)
                noheader=1
                ;;
            --no-pager)
                nopager='--no-pager'
                ;;
            -mindepth|--mindepth)
                shift
                if (( $# < 1 )) ; then >&2 echo "-mindepth requires an argument"; exit 1; fi
                mindepth="$1"
                ;;
            -maxdepth|--maxdepth)
                shift
                if (( $# < 1 )) ; then >&2 echo "-maxdepth requires an argument"; exit 1; fi
                maxdepth="$1"
                ;;
        esac
        shift
    done
    case "${action}" in
        list)
            GIT-FIND-LIST "$@"
            ;;
        find)
            GIT-FIND "$@"
            ;;
    esac
}

GIT-FIND-LIST () {
    if (( verbose )) ; then
        find . \
             ${mindepth:+-mindepth "${mindepth}"} \
             ${maxdepth:+-maxdepth "${maxdepth}"} \
             -type d \
             \! \( -name node_modules -prune \) \
             \! \( -exec test -d '{}/.git' \; -print -prune \) -exec echo '# {}' \;
    else
        find . \
             ${mindepth:+-mindepth "${mindepth}"} \
             ${maxdepth:+-maxdepth "${maxdepth}"} \
             -type d \
             \! \( -name node_modules -prune \) \
             -exec test -d '{}/.git' \; -print -prune
    fi
}

GIT-FIND () {
    local -a find1
    local -a find2
    local -a find3
    local -a find
    if (( $# )) ; then
        if (( inline )) ; then
            find . \
                 ${mindepth:+-mindepth "${mindepth}"} \
                 ${maxdepth:+-maxdepth "${maxdepth}"} \
                 -type d \
                 \! \( -name node_modules -prune \) \
                 -exec test -d '{}/.git' \; \
                 -prune \
                 -exec git in-dir $nopager -p'[{}] ' {} "$@" \;
        else
            find1=(
                find .
                ${mindepth:+-mindepth "${mindepth}"}
                ${maxdepth:+-maxdepth "${maxdepth}"}
                -type d
                \! \( -name node_modules -prune \)
                -exec test -d '{}/.git' \;
            )
            find2=(
                -exec echo "${green}==> {} <==${reset}" \;
            )
            find3=(
                -prune
                -exec git in-dir $nopager {} "$@" \;
            )
            if (( noheader )) ; then
                find=(
                    "${find1[@]}"
                    "${find3[@]}"
                )
            else
                find=(
                    "${find1[@]}"
                    "${find2[@]}"
                    "${find3[@]}"
                )
            fi
            "${find[@]}"
        fi
    else
        GIT-FIND-LIST
    fi
}

#------------------------------------------------------------------------------
MAIN "$@"
