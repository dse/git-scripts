#!/usr/bin/env bash
set -o errexit
set -o pipefail

progname="$(basename "$0")"
dirname="$(dirname "$0")"

. "${dirname}/../share/bash-getlongopts/getlongopts.sh"
. "${dirname}/../share/git-scripts/git-scripts.sh"

main () {
    if (( $# < 1 )) ; then
        >&2 echo "usage: git merge-into <branch>"
        exit 1
    fi

    local dest source

    dest="$1"
    source="$(git rev-parse --abbrev-ref HEAD)"

    git checkout "${dest}" || croak $? "${source}" <<EOF
        |
        |*** \`git checkout ${dest}\` failed.
EOF

    git merge "${source}" || croak $? "${source}" <<EOF
        |
        |*** \`git merge ${source}\` into ${dest} failed.
EOF

    git push || croak $? "${source}" <<EOF
        |
        |*** merge successful, but \`git push\` into ${dest} failed.
EOF

    git checkout "${source}" || croak $? "${source}" <<EOF
        |
        |*** merge and push successful, but \`git checkout ${source}\` failed.
EOF

    sendoff <<EOF
        |
        |*** ALL DONE.  :-)
EOF
}

###############################################################################

main "$@"
