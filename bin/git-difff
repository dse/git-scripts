#!/usr/bin/env bash
set -o errexit
set -o pipefail

no_index=0
for i ; do
    if [[ "$i" = "--no-index" ]] ; then
        no_index=1
    fi
done

declare -a difff_global_options
declare -a difff_options
declare -a difff_arguments

difff_global_options=(
    -c core.whitespace=cr-at-eol
)

difff_options=(
    --ignore-space-at-eol
    --ignore-space-change
    --ignore-all-space
    --ignore-blank-lines
    --diff-filter=ad
    --no-prefix
)

difff_arguments=(
    ":(exclude,icase)package-lock.json"
    ":(exclude,icase)composer.lock"
    ":(exclude,icase)*.min.css"
    ":(exclude,icase)*.css.map"
    ":(exclude,icase)*.min.js"
    ":(exclude,icase)*.js.map"
    ":(exclude,icase)*.jpg"
    ":(exclude,icase)*.jpeg"
    ":(exclude,icase)*.png"
    ":(exclude,icase)*.gif"
    ":(exclude,icase)parsed/templates/"
    ":(exclude,icase)parsed/scss/"
    ":(exclude,icase)parsed/lang.json"
)

if git diff --ignore-cr-at-eol --no-index /dev/null /dev/null >/dev/null 2>/dev/null ; then
    difff_options+=(--ignore-cr-at-eol)
fi

# Special `git logg` mode (see `git-logg` program).
if (( $# )) && [[ "$1" = "{logg}" ]] ; then
    shift
    exec git "${difff_global_options[@]}" log --patch "${difff_options[@]}" "$@" "${difff_arguments[@]}"
fi

if (( no_index )) ; then
    # git diff --no-index does not take ":(exclude,...)..." arguments.
    exec git "${difff_global_options[@]}" diff "${difff_options[@]}" "$@"
fi

exec git "${difff_global_options[@]}" diff "${difff_options[@]}" "$@" "${difff_arguments[@]}"
