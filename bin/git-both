#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset
shopt -s lastpipe

MAIN () {
    local root="$(git rev-parse --show-toplevel)"
    cd "${root}"

    local -a filenames=()
    git diff --name-only --diff-filter=U | mapfile -t filenames
    if (( ! ${#filenames[@]} )) ; then
        >&2 echo "no files with conflicts."
        exit 0
    fi

    excludefile="${root}/.git/info/exclude"
    grep -x -F '*--BASE.*' "${excludefile}" >/dev/null 2>&1	|| echo '*--BASE.*' >> "${excludefile}"
    grep -x -F '*--OURS.*' "${excludefile}" >/dev/null 2>&1	|| echo '*--OURS.*' >> "${excludefile}"
    grep -x -F '*--THEIRS.*' "${excludefile}" >/dev/null 2>&1	|| echo '*--THEIRS.*' >> "${excludefile}"
    grep -x -F '*--BASE' "${excludefile}" >/dev/null 2>&1	|| echo '*--BASE' >> "${excludefile}"
    grep -x -F '*--OURS' "${excludefile}" >/dev/null 2>&1	|| echo '*--OURS' >> "${excludefile}"
    grep -x -F '*--THEIRS' "${excludefile}" >/dev/null 2>&1	|| echo '*--THEIRS' >> "${excludefile}"

    local basename
    local dirname
    local basenamenoext
    local ext
    for filename in "${filenames[@]}" ; do
	basename="$(basename "$filename")"
	dirname="$(dirname "$filename")"
	case "${basename}" in
	    .*.*)
		basenamenoext="${basename%.*}"
		ext=".${basename##*.}"
		;;
	    .*)
		basenamenoext="${basename%.*}"
		ext=".${basename##*.}"
		;;
	    *.*)
		basenamenoext="${basename%.*}"
		ext=".${basename##*.}"
		;;
	    *)
		basenamenoext="${basename%.*}"
		ext=".${basename##*.}"
		;;
	esac
	local base="${dirname}/${basenamenoext}--BASE${ext}"
	local ours="${dirname}/${basenamenoext}--OURS${ext}"
	local theirs="${dirname}/${basenamenoext}--THEIRS${ext}"

	git show ":1:${filename}" >"${base}"
	echo "${base}"
	git show ":2:${filename}" >"${ours}"
	echo "${ours}"
	git show ":3:${filename}" >"${theirs}"
	echo "${theirs}"

	diff -u -w "${base}" "${theirs}" >"${theirs}.diff" || true
	echo "${theirs}.diff"
	wc -l "${theirs}.diff" 
	diff -u -w "${base}" "${ours}" >"${ours}.diff" || true
	echo "${ours}.diff"
	wc -l "${ours}.diff" 
    done
}

###############################################################################
MAIN "$@"
